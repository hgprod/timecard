[gd_scene load_steps=3 format=3 uid="uid://c3hahjuufpmau"]

[sub_resource type="GDScript" id="GDScript_6v7fx"]
script/source = "extends VBoxContainer

func _on_show_panel():
	%ReportControl.redraw()
"

[sub_resource type="GDScript" id="GDScript_mip8u"]
script/source = "extends Node

@export var _display: Tree

var _sum_task_time: bool

func redraw():
	_draw_tree()

func _draw_tree():
	_display.clear()
	_display.create_item()
	_build_cat_tree(Project.get_data().get_categories().get_categories_for_parent(null), null)

func _build_cat_tree(list: Array[Category], parent: TreeItem) -> int:
	var time_sum: int = 0
	var cat_data := Project.get_data().get_categories()
	for item in list:
		var branch := _display.create_item(parent)
		branch.set_text(0, item.get_category_name())
		var children := cat_data.get_categories_for_parent(item)
		var time = _get_time_for_cat(item)
		if children.size() != 0:
			time += _build_cat_tree(children, branch)
		branch.set_text(1, Task.format_time_string(time))
		time_sum += time
	return time_sum if _sum_task_time else 0

func _get_time_for_cat(cat: Category) -> int:
	var tasks := Project.get_data().get_task_list()
	var time: int = 0
	for item in tasks:
		if item.get_category_id() == cat.get_category_id() and not item.is_running():
			time += item.get_elapsed_time()
	return time

func _on_sum_task_toggled(toggled_on: bool) -> void:
	_sum_task_time = toggled_on
	_draw_tree()
"

[node name="ReportPanel" type="VBoxContainer"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_6v7fx")

[node name="SumTask" type="CheckButton" parent="."]
layout_mode = 2
size_flags_horizontal = 3
text = "Category Time Include Sub-Category Times"

[node name="Tree" type="Tree" parent="."]
layout_mode = 2
size_flags_vertical = 3
columns = 2
hide_root = true

[node name="ReportControl" type="Node" parent="." node_paths=PackedStringArray("_display")]
unique_name_in_owner = true
script = SubResource("GDScript_mip8u")
_display = NodePath("../Tree")

[connection signal="toggled" from="SumTask" to="ReportControl" method="_on_sum_task_toggled"]
